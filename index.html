<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traduttore Vocale - Hotel Noris</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fffbeb; 
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .trail-effect {
            position: relative;
            overflow: hidden;
        }
        .trail-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        .trail-effect:hover::after {
            transform: translateX(100%);
        }
        
        .custom-select-wrapper {
            position: relative;
        }
        .custom-select-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem;
        }
        .custom-select-wrapper::after {
            content: '▼';
            font-size: 0.8rem;
            color: #b45309; /* amber-700 */
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        canvas {
            width: 100%;
            height: 80px;
            display: block;
        }
        /* Stili per la schermata di blocco */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 251, 235, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- NUOVO: Schermata di blocco con password -->
    <div id="password-overlay">
        <div class="text-center bg-white/50 p-10 rounded-2xl shadow-xl w-full max-w-md">
            <img src="NORIS LOGO.png" alt="Logo Hotel Noris" class="h-40 mx-auto mb-6">
            <h2 class="text-2xl font-bold text-amber-800 mb-2">Accesso Riservato</h2>
            <p class="text-gray-600 mb-6">Inserisci la password per continuare.</p>
            <input type="password" id="password-input" class="w-full p-3 text-center text-lg border-2 border-amber-200 rounded-lg focus:ring-amber-500 focus:border-amber-500" placeholder="••••••••">
            <button id="password-submit" class="w-full mt-4 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg text-lg transition-all">Entra</button>
            <p id="password-error" class="text-red-600 mt-2 h-4"></p>
        </div>
    </div>

    <div class="w-full max-w-6xl glass-container rounded-3xl shadow-2xl p-6 md:p-10 fade-in-up">
        
        <header class="text-center mb-8">
            <img src="NORIS LOGO.png" alt="Logo Hotel Noris" class="h-48 mx-auto mb-4">
            <p class="text-gray-600 mt-2 text-lg">Your conversation, without barriers.</p>
        </header>

        <div id="unsupported-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg" role="alert">
            <p class="font-bold">Browser non supportato</p>
            <p>Spiacenti, il tuo browser non supporta le API Web Speech necessarie. Prova con Google Chrome o Microsoft Edge.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Pannello Persona 1 -->
            <div id="person1" class="bg-white/50 rounded-2xl p-6 flex flex-col space-y-4 transition-all duration-300 hover:shadow-lg trail-effect">
                <div class="flex items-center space-x-4">
                    <img id="flag1" src="" alt="Bandiera nazione 1" class="w-12 h-8 rounded-md object-cover shadow-md">
                    <div class="custom-select-wrapper w-full">
                        <select id="lang1" class="w-full bg-gray-100 border-2 border-transparent focus:border-amber-500 text-gray-800 font-semibold text-lg rounded-lg focus:ring-0 block p-3">
                        </select>
                    </div>
                </div>
                <div class="flex-grow flex flex-col justify-between">
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-amber-800">Testo originale:</p>
                        <div id="output1_original" class="w-full min-h-[100px] p-3 bg-gray-50/70 rounded-md text-gray-700 text-lg"></div>
                        <p class="text-sm font-medium text-amber-800">Traduzione:</p>
                        <div id="output1_translated" class="w-full min-h-[100px] p-3 bg-amber-50/80 rounded-md text-gray-900 text-lg font-semibold"></div>
                    </div>
                    <div class="relative h-[80px] my-4">
                        <canvas id="soundwave1"></canvas>
                    </div>
                    <button id="speak1" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-4 rounded-xl flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-amber-300 text-lg trail-effect">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 10-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h2a1 1 0 100-2v-2.07z" clip-rule="evenodd"></path></svg>
                        <span id="speak1-text">Parla</span>
                    </button>
                </div>
            </div>

            <!-- Pannello Persona 2 -->
            <div id="person2" class="bg-white/50 rounded-2xl p-6 flex flex-col space-y-4 transition-all duration-300 hover:shadow-lg trail-effect">
                <div class="flex items-center space-x-4">
                    <img id="flag2" src="" alt="Bandiera nazione 2" class="w-12 h-8 rounded-md object-cover shadow-md">
                    <div class="custom-select-wrapper w-full">
                        <select id="lang2" class="w-full bg-gray-100 border-2 border-transparent focus:border-amber-500 text-gray-800 font-semibold text-lg rounded-lg focus:ring-0 block p-3">
                        </select>
                    </div>
                </div>
                <div class="flex-grow flex flex-col justify-between">
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-amber-800">Testo originale:</p>
                        <div id="output2_original" class="w-full min-h-[100px] p-3 bg-gray-50/70 rounded-md text-gray-700 text-lg"></div>
                        <p class="text-sm font-medium text-amber-800">Traduzione:</p>
                        <div id="output2_translated" class="w-full min-h-[100px] p-3 bg-amber-50/80 rounded-md text-gray-900 text-lg font-semibold"></div>
                    </div>
                     <div class="relative h-[80px] my-4">
                        <canvas id="soundwave2"></canvas>
                    </div>
                    <button id="speak2" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-4 rounded-xl flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-amber-300 text-lg trail-effect">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 017 8a1 1 0 10-2 0 7.001 7.001 0 006 6.93V17H9a1 1 0 100 2h2a1 1 0 100-2v-2.07z" clip-rule="evenodd"></path></svg>
                        <span id="speak2-text">Parla</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ReactiveSoundWave {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.animationFrameId = null;
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.dataArray = null;
                this.stream = null;
                this.isActive = false;
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;
            }

            async connect(stream) {
                if (this.isActive) return;
                this.stream = stream;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 256;
                this.source = this.audioContext.createMediaStreamSource(this.stream);
                this.source.connect(this.analyser);
                
                const bufferLength = this.analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(bufferLength);
                this.isActive = true;
                this.draw();
            }

            draw() {
                if (!this.isActive) return;

                this.animationFrameId = requestAnimationFrame(() => this.draw());
                this.analyser.getByteFrequencyData(this.dataArray);

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const bufferLength = this.analyser.frequencyBinCount;
                const barWidth = (this.canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, 'rgba(217, 119, 6, 0.8)');   /* amber-500 */
                gradient.addColorStop(1, 'rgba(252, 211, 77, 0.5)'); /* amber-300 */

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = this.dataArray[i] / 2;
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }

            stop() {
                if (!this.isActive) return;
                this.isActive = false;
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }
                this.stream?.getTracks().forEach(track => track.stop());
                this.audioContext?.close();
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // --- GESTIONE PASSWORD ---
            const passwordOverlay = document.getElementById('password-overlay');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordError = document.getElementById('password-error');
            
            // !!! CAMBIA LA TUA PASSWORD QUI !!!
            const correctPassword = "29062024"; 

            function checkPassword() {
                if (passwordInput.value === correctPassword) {
                    passwordOverlay.style.opacity = '0';
                    setTimeout(() => {
                        passwordOverlay.style.display = 'none';
                    }, 500);
                } else {
                    passwordError.textContent = 'Password errata. Riprova.';
                    passwordInput.classList.add('border-red-500');
                }
            }

            passwordSubmit.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
            // --- FINE GESTIONE PASSWORD ---


            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const synthesis = window.speechSynthesis;
            const unsupportedMessage = document.getElementById('unsupported-message');

            if (!SpeechRecognition || !synthesis) {
                unsupportedMessage.classList.remove('hidden');
                document.querySelector('.grid').classList.add('hidden');
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const lang1Select = document.getElementById('lang1');
            const lang2Select = document.getElementById('lang2');
            const speak1Btn = document.getElementById('speak1');
            const speak2Btn = document.getElementById('speak2');
            const speak1Text = document.getElementById('speak1-text');
            const speak2Text = document.getElementById('speak2-text');
            const output1Original = document.getElementById('output1_original');
            const output1Translated = document.getElementById('output1_translated');
            const output2Original = document.getElementById('output2_original');
            const output2Translated = document.getElementById('output2_translated');
            const flag1 = document.getElementById('flag1');
            const flag2 = document.getElementById('flag2');

            const soundWave1 = new ReactiveSoundWave('soundwave1');
            const soundWave2 = new ReactiveSoundWave('soundwave2');

            let activeUser = null; 
            let activeStream = null;

            const languages = [
                { code: 'it-IT', name: 'Italiano', countryCode: 'it' },
                { code: 'en-US', name: 'Inglese (US)', countryCode: 'us' },
                { code: 'es-ES', name: 'Spagnolo', countryCode: 'es' },
                { code: 'fr-FR', name: 'Francese', countryCode: 'fr' },
                { code: 'de-DE', name: 'Tedesco', countryCode: 'de' },
                { code: 'pt-PT', name: 'Portoghese', countryCode: 'pt' },
                { code: 'sq-AL', name: 'Albanese', countryCode: 'al' },
                { code: 'cs-CZ', name: 'Ceco', countryCode: 'cz' },
                { code: 'da-DK', name: 'Danese', countryCode: 'dk' },
                { code: 'fi-FI', name: 'Finlandese', countryCode: 'fi' },
                { code: 'el-GR', name: 'Greco', countryCode: 'gr' },
                { code: 'nl-NL', name: 'Olandese', countryCode: 'nl' },
                { code: 'hu-HU', name: 'Ungherese', countryCode: 'hu' },
                { code: 'mg-MG', name: 'Malgascio', countryCode: 'mg' },
                { code: 'nb-NO', name: 'Norvegese', countryCode: 'no' },
                { code: 'pl-PL', name: 'Polacco', countryCode: 'pl' },
                { code: 'ro-RO', name: 'Rumeno', countryCode: 'ro' },
                { code: 'ru-RU', name: 'Russo', countryCode: 'ru' },
                { code: 'sk-SK', name: 'Slovacco', countryCode: 'sk' },
                { code: 'sv-SE', name: 'Svedese', countryCode: 'se' },
                { code: 'tr-TR', name: 'Turco', countryCode: 'tr' },
                { code: 'uk-UA', name: 'Ucraino', countryCode: 'ua' },
                { code: 'ar-SA', name: 'Arabo', countryCode: 'sa' },
                { code: 'pt-BR', name: 'Brasiliano', countryCode: 'br' },
                { code: 'zh-CN', name: 'Cinese', countryCode: 'cn' },
                { code: 'ja-JP', name: 'Giapponese', countryCode: 'jp' },
                { code: 'hi-IN', name: 'Hindi', countryCode: 'in' }
            ];

            let voices = [];

            function updateFlag(selectElement, flagElement) {
                const selectedLangCode = selectElement.value;
                const langData = languages.find(l => l.code === selectedLangCode);
                if (langData) {
                    flagElement.src = `https://flagcdn.com/w40/${langData.countryCode}.png`;
                    flagElement.alt = `Bandiera ${langData.name}`;
                }
            }

            function populateLanguageLists() {
                const sortedLanguages = [...languages].sort((a, b) => a.name.localeCompare(b.name));
                sortedLanguages.forEach(lang => {
                    [lang1Select, lang2Select].forEach(select => {
                         select.add(new Option(lang.name, lang.code));
                    });
                });
                lang1Select.value = 'it-IT';
                lang2Select.value = 'en-US';
                updateFlag(lang1Select, flag1);
                updateFlag(lang2Select, flag2);
            }

            function getVoices() {
                voices = synthesis.getVoices();
            }

            populateLanguageLists();
            setTimeout(getVoices, 200);
            if (synthesis.onvoiceschanged !== undefined) {
                synthesis.onvoiceschanged = getVoices;
            }

            lang1Select.addEventListener('change', () => updateFlag(lang1Select, flag1));
            lang2Select.addEventListener('change', () => updateFlag(lang2Select, flag2));

            async function handleSpeak(userIndex) {
                if (activeUser === null) {
                    try {
                        activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        activeUser = userIndex;
                        const activeWave = (userIndex === 1) ? soundWave1 : soundWave2;
                        activeWave.connect(activeStream);
                        
                        recognition.lang = (userIndex === 1) ? lang1Select.value : lang2Select.value;
                        recognition.start();

                    } catch (error) {
                        console.error("Errore accesso al microfono:", error);
                        alert("Impossibile accedere al microfono. Controlla i permessi.");
                        resetUI();
                    }
                } else if (activeUser === userIndex) {
                    recognition.stop();
                }
            }
            
            function updateUIForListening() {
                if (!activeUser) return;
                const [activeBtn, activeText, inactiveBtn] = (activeUser === 1)
                    ? [speak1Btn, speak1Text, speak2Btn]
                    : [speak2Btn, speak2Text, speak1Btn];
                
                activeText.textContent = 'In ascolto...';
                activeBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                activeBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                inactiveBtn.disabled = true;
            }

            function resetUI() {
                speak1Text.textContent = 'Parla';
                speak2Text.textContent = 'Parla';
                [speak1Btn, speak2Btn].forEach(btn => {
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    btn.disabled = false;
                });
                soundWave1.stop();
                soundWave2.stop();
                activeUser = null;
                activeStream = null;
            }

            async function translateText(text, sourceLangCode, targetLangCode) {
                const sourceLangName = languages.find(l => l.code === sourceLangCode)?.name || sourceLangCode;
                const targetLangName = languages.find(l => l.code === targetLangCode)?.name || targetLangCode;
                
                const prompt = `Traduci letteralmente questa frase da ${sourceLangName} a ${targetLangName}: "${text}". Fornisci solo la traduzione diretta senza frasi introduttive o commenti.`;

                const apiKey = "AIzaSyATjmMYEYf3rVstXEAbWSolZpX1eo34FFI";
                
                if (apiKey === "INCOLLA_LA_TUA_CHIAVE_API_DI_GOOGLE_AI_QUI") {
                    const translatedOutput = activeUser === 1 ? output1Translated : output2Translated;
                    translatedOutput.textContent = "ERRORE: Inserisci una chiave API valida.";
                    return "Chiave API non configurata.";
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Errore API: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        return result.candidates[0].content.parts[0].text.trim();
                    }
                    return "Traduzione non disponibile.";
                } catch (error) {
                    console.error('Errore traduzione:', error);
                    return `Errore di traduzione.`;
                }
            }

            function speakText(text, langCode) {
                if (synthesis.speaking) synthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langCode;
                
                const languageVoices = voices.filter(v => v.lang === langCode);
                let bestVoice = null;
                if (languageVoices.length > 0) {
                    const preferredVoices = ['Elsa', 'Microsoft Elsa', 'Alice', 'Federica', 'Paola', 'Nora', 'Microsoft Nora', 'Pernille', 'Google', 'Microsoft', 'Apple', 'Female'];
                    for (const preferredName of preferredVoices) {
                        bestVoice = languageVoices.find(voice => voice.name.includes(preferredName));
                        if (bestVoice) break;
                    }
                    if (!bestVoice) bestVoice = languageVoices[0];
                }

                if (bestVoice) {
                    utterance.voice = bestVoice;
                    console.log(`Voce selezionata: ${bestVoice.name}`);
                } else {
                    console.warn(`Nessuna voce trovata per ${langCode}.`);
                }
                
                synthesis.speak(utterance);
            }

            speak1Btn.addEventListener('click', () => handleSpeak(1));
            speak2Btn.addEventListener('click', () => handleSpeak(2));
            
            recognition.onstart = updateUIForListening;

            recognition.onresult = async (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    finalTranscript += event.results[i][0].transcript;
                }

                if (!activeUser || !finalTranscript) return;

                const currentUser = activeUser; 
                const [sourceLang, targetLang, originalOutput, translatedOutput] = (currentUser === 1)
                    ? [lang1Select.value, lang2Select.value, output1Original, output2Translated]
                    : [lang2Select.value, lang1Select.value, output2Original, output1Translated];
                
                originalOutput.textContent = finalTranscript.trim();
                translatedOutput.textContent = 'Traduzione in corso...';
                
                const translatedText = await translateText(finalTranscript.trim(), sourceLang, targetLang);
                translatedOutput.textContent = translatedText;
                speakText(translatedText, targetLang);
            };

            recognition.onerror = (event) => {
                console.error('Errore riconoscimento:', event.error);
                resetUI();
            };

            recognition.onend = resetUI;
        });
    </script>
</body>
</html>
